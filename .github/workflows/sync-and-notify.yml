name: Sync Upstream & Notify MD Changes

on:
  schedule:
    - cron: "*/1 * * * *"   # æ¯ 1 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1. æ‹‰å–ä½ çš„ fork ä»“åº“
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. æ·»åŠ  upstreamï¼ˆåŸå§‹ä»“åº“ binance/binance-spot-api-docsï¼‰
      - name: Add upstream
        run: |
          git remote add upstream https://github.com/binance/binance-spot-api-docs.git
          git fetch upstream

      # 3. æ¯”è¾ƒä½ å½“å‰åˆ†æ”¯ä¸ upstream/master çš„å·®å¼‚
      - name: Compare commits
        id: diff
        run: |
          git log HEAD..upstream/master --name-only > changes.txt || true
          echo "changed=$(cat changes.txt | xargs)" >> $GITHUB_OUTPUT

      # 4. è‹¥æ²¡æœ‰å˜åŒ–ï¼Œç»“æŸ
      - name: No upstream change
        if: ${{ steps.diff.outputs.changed == '' }}
        run: echo "No upstream updates."

      # 5. æœ‰å˜åŒ– â†’ merge upstream å†…å®¹åˆ°ä½ çš„ä»“åº“
      - name: Merge upstream changes
        if: ${{ steps.diff.outputs.changed != '' }}
        run: |
          git merge upstream/master --no-edit
          git push origin master

      # 6. æ£€æŸ¥æ˜¯å¦åŒ…å« .md æ–‡ä»¶å˜æ›´
      - name: Detect MD changes
        id: mdcheck
        run: |
          if grep -E "\.md$" changes.txt; then
            echo "md_changed=true" >> $GITHUB_OUTPUT
          else
            echo "md_changed=false" >> $GITHUB_OUTPUT
          fi

      # 7. æœ‰ .md æ›´æ–° â†’ å‘é€é’‰é’‰é€šçŸ¥ï¼ˆä½¿ç”¨ secretsï¼‰
      - name: Notify DingTalk
        if: ${{ steps.mdcheck.outputs.md_changed == 'true' }}
        env:
          WEBHOOK: ${{ secrets.DINGDING_WEBHOOK }}
        run: |
          TEXT="ğŸ“¢ Binance API æ–‡æ¡£ï¼ˆä¸Šæ¸¸ä»“åº“ï¼‰Markdown æ–‡ä»¶æ›´æ–°ï¼\nä»“åº“ï¼šbinance/binance-spot-api-docs\næ—¶é—´ï¼š$(date)\nå˜æ›´æ–‡ä»¶ï¼š\n$(grep .md changes.txt)"
          curl -X POST "$WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
              \"msgtype\": \"text\",
              \"text\": {\"content\": \"$TEXT\"}
            }"
